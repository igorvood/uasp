# Универсальный атомарный сервис uasp-streaming-recovery для восстановления состояний Flink после сбоя

Сервис предназначен для восстановления любого pipeline при условии, что все справочники необходимые для состояния входят в pipeline не через основной поток данных. Например, если необходимо восстановить состояние в aggregate, он должен слушать специальную очередь с данными для восстановления, объединять её с основным потоком и выполнять логику каждого сообщения стандартным образом.
Задача сервиса uasp-streaming-recovery остановить основной поток данных до момента восстановления состояния всех сервисов pipeline.

## Топики для восстановления

Для каждого входящего потока транзакционных данных (например ЦФТ,Way4, Профайл) создаём два дополнительных топика топик А (боковая очердь), топик Б.
Основной входной поток в сервис назовём M.
Основной выходной поток назовём O на вход в input-converter. 
Перед input-converter устанавливаем специальный сервис uasp-streaming-recovery для восстановления, который будет слушать основной входящий топик М и топик Б и писать в топик А при включенной опции восстановления.

## Общее описание механизма восстановления

Во время старта сервиса uasp-streaming-recovery передаём через аргументы командной строки опцию recovery = true.
При включенной опции recovery = true сервис uasp-streaming-recovery перебрасывает все сообщения из топика М в топик А (тип данных InputMessageType для передачи данных, в заголовки headers добавляем время и дату прихода сообщения system-recovery-datetime и system-recovery-guid со сгенерированным guid). В функции reduce класса ReduceFunction устанавливаем в переменной guid значение из InputMessageType.headers("system-recovery-guid") сообщения из топика М.  
Сервис uasp-streaming-recovery при приёме сообщений добавляет информацию с какого потока приходит сообщение M или Б. И подготавливает структуру Tuple содержащий в себе название топика, сообщение InputMessageType, опция восстановления и guid сообщения (из топика М).
Сообщения из потока Б всегда отправляем в исходящий поток для uasp-streaming-input-convertor. 
Для вычисления опции о завершении восстановления recovery необходимо использовать класс ReduceFunction, который позволяет передавать текущую опцию восстановления, а так же информацию (guid) для вычисления завершения восстановления. Важно от сообщения к сообщению в Tuple перекладывать текущий guid и опцию восстановления.  
В функции reduce класса ReduceFunction выполняем вычисление: если recovery = true и guid установленный из сообщения топика М совпал с guid из текущего сообщения топика Б InputMessageType.headers("system-recovery-guid"), то устанавливаем recovery = false, после чего перестаём сравнивать guid.
Для сообщений из топика М и установленной опцией recovery = true перекладываем сообщения в боковую очередь в топик А, иначе отправляем в uasp-streaming-input-convertor. 
После выставления опции recovery = false сообщения из потока M перестают отправляться в очередь A и идут сразу на вход в uasp-streaming-input-convertor.
В фильтре после aggregate отбрасываем все сообщения с RECOVERY_FLG = true (необходимо для восстановления сервисов агрегации).

##Пошаговый механизм восстановления

1. Формируем витрины для восстановления состояний.
2. Запускаем сервис main, который содержит в себе aggregate, uasp-streaming-recovery и input-converter, filter и т.д. с опцией recovery = true для uasp-streaming-recovery и датой временем с какого момента необходимо читать топики. Все сообщения при включенной опции recovery = true должны перекладываться в боковую очередь А.
3. Выполняем выгрузку данных со значением RECOVERY_FLG = true из холодного хранилища в топики для восстановления состояния в сервисах агрегации, как при первом запуске сервиса (например ожидается, что топик агрегации загружает данные из топика холодного хранилища и выполняет обработку его стандартным образом). В фильтре после aggregate отбрасываем все сообщения с RECOVERY_FLG = true.
4. Загружаем все справочники для обогатителя, дожидаемся попадание всех данных в состояние.
5. Запускаем unp-converter для перекладки сообщений из топика А в топик Б. C этого момента в uasp-streaming-recovery  начинают поступать сообщения из топика Б и объединятся (union) с сообщениями из топика M. Сообщения из топика Б при прохождении через ReduceFunction проверяются на совпадения переменной guid из Tuple с InputMessageType.headers("system-recovery-guid") из сообщения топика Б, при совпадении устанавливаем recovery = false.
6. Сообщения при установленной опции recovery = false из топика М перестают перекладываться в топик А и отправляются на прямую на вход в input-converter. 

##Что произойдёт при падении uasp-streaming-recovery

Так как сервис uasp-streaming-recovery stateless (без сохранения состояния), то при падении сервиса на какой-либо ноде сервис uasp-streaming-recovery восстановится по умолчанию с опицией восстановления recovery = true, но так как при штатном режиме обработки pipeline запущен unp-converter который перекладывает сообщения из А в Б, то сервис после нескольких сообщений автоматически перейдёт в режим recovery = false при котором не будет перекладывать сообщения в топик A, а напрямую отправлять сообщения из топика M в uasp-streaming-input-convertor. 
